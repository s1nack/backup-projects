<?php

class Scan_model extends CI_Model {
	function create_scan($sid, $name)
	{
		//$tdate = getdate();
		//$now = $tdate['year']."-".$tdate['mday']."-".$tdate['mon']; // MM-DD-YYYY
		$now = time(); 
		//$now = date('Y-m-d H:i:s', strtotime(str_replace('-', '/', $date)));
		
		$new_scan_insert_data = array(
				'scan_type' => "scan_type",
				'file' => $name,
				'start_date' => $now,
				'fk_site_id' => $sid,
				'fk_user_id' => $this->session->userdata('id'),
		);
		
		$insert = $this->db->insert('scan_result', $new_scan_insert_data);
		$insertid = $this->db->insert_id();
		return $insertid;
	}
	
	function getScanIdsByUserid($userid) 
	{
		$query = $this->db->query("SELECT id FROM scan_result WHERE fk_user_id='".$userid."'");
		return $query->result_array();
	}
	
	function getLastScanInfos($siteid)
	{
		$query = $this->db->query("SELECT id,file,start_date,nb_vuln_crit,nb_vuln_med,nb_vuln_low FROM scan_result WHERE fk_site_id='".$siteid."' ORDER BY id DESC LIMIT 1");
		return $query->result_array();
	}
	
	function get_all($scans)
	{
		$querystr = "SELECT * FROM scan_result WHERE id=";
		$i = 0;
		foreach($scans as $scan)
		{
			$hhh = $this->db->query("SELECT fk_user_id FROM scan_result WHERE id='".$scan."'");
			foreach ($hhh->result() as $jjj) 
			{ 
				$sUserId = $jjj->fk_user_id; 
			}
			if ($sUserId != $this->session->userdata('id'))
			{
				return;
			}
			
			if ($i == 0)
			{
				$querystr = $querystr . $scan;
			}
			else 
			{
				$querystr = $querystr . " OR id=".$scan;
			}
			$i++;
		}
		$query = $this->db->query($querystr);
		//print_r($query);
		return $query;
	}
}