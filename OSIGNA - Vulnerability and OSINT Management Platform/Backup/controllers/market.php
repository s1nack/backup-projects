<?php

class Market extends CI_Controller {

	function index($src = NULL)
	{	
		// Load view
		$data['main_content'] = 'marketstudy_form';
		$opt_load = array(
		'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-1.4.2.min.js"></script>',
		'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery.smartWizard-2.0.min.js"></script>',
		'<link rel="stylesheet" href="http://www.datalabsecurity.com/webscan/resources/css/smart_wizard.css" type="text/css" />',
		);
		$title = "Market study";
		$opt_head = array(
			"opt_load" => $opt_load,
			"title" => $title,
			"src" => $src,
		);
		$data['opt_head'] = $opt_head;
		$this->load->view('includes/templatemarket', $data); //change
	}
	
	function foo()
	{
		$data['main_content'] = 'marketstudy_form_results';
		$title = "Results page";
		$opt_head = array(
			"title" => $title,
		);
		$data['opt_head'] = $opt_head;
		$this->load->view('includes/templatemarket', $data);
	}
	
	function register()
	{
		$this->load->model('market_model');
		$ret = $this->market_model->save_optin_mail($this->input->post('optin_email'));
		echo "Done.";
	}
	
	function validate_market()
	{
		$results = array();
		$pro = 'none';
		$dipl = 'none';
		$template = 'none';
		$vulns = '';
		$secsolution = 'none';
		$reason = 'none';
		$sitetypes = '';
		$statut = '';
		
		$ip = $_SERVER['REMOTE_ADDR'];
		$age = $this->input->post('age');
		$sex = $this->input->post('sexe');
		if($this->input->post('pro') != null) { $pro = $this->input->post('pro'); }
		if($this->input->post('statut1')) { $statut = $statut.'2'; } else { $statut = $statut.'1'; }
		if($this->input->post('statut2')) { $statut = $statut.'2'; } else { $statut = $statut.'1'; }
		if($this->input->post('statut3')) { $statut = $statut.'2'; } else { $statut = $statut.'1'; }
		if($this->input->post('dipl') != null) { $dipl = $this->input->post('dipl'); }
		$n = $this->input->post('nbsites');
		$h = $this->input->post('hostingtype');
		if($this->input->post('template') != null) { $template = $this->input->post('template'); }
		if($this->input->post('sitetype1')) { $sitetypes = $sitetypes.'2'; } else { $sitetypes = $sitetypes.'1'; }
		if($this->input->post('sitetype2')) { $sitetypes = $sitetypes.'2'; } else { $sitetypes = $sitetypes.'1'; }
		if($this->input->post('sitetype3')) { $sitetypes = $sitetypes.'2'; } else { $sitetypes = $sitetypes.'1'; }
		if($this->input->post('sitetype4')) { $sitetypes = $sitetypes.'2'; } else { $sitetypes = $sitetypes.'1'; }
		if($this->input->post('sitetype5')) { $sitetypes = $sitetypes.'2'; } else { $sitetypes = $sitetypes.'1'; }
		$know = $this->input->post('know');
		if($this->input->post('vulns1')) { $vulns = $vulns.'2'; } else { $vulns = $vulns.'1'; }
		if($this->input->post('vulns2')) { $vulns = $vulns.'2'; } else { $vulns = $vulns.'1'; }
		if($this->input->post('vulns3')) { $vulns = $vulns.'2'; } else { $vulns = $vulns.'1'; }
		if($this->input->post('vulns4')) { $vulns = $vulns.'2'; } else { $vulns = $vulns.'1'; }
		$vuln_know = $this->input->post('vuln_know');
		$exp = $this->input->post('exp');
		$happen = $this->input->post('happen');
		$existsec = $this->input->post('existsec');
		if($this->input->post('secsolution') != null) { $secsolution = $this->input->post('secsolution'); }
		$interest = $this->input->post('interest');
		$p = $this->input->post('price');
		$comment = $this->input->post('comment');
		$src = $this->input->post('src');
		$reason = $this->input->post('reason');
		$now = date('d-m-Y H:i');
		
		array_push($results, $ip, $age, $sex, $pro, $dipl, $n, $h, $template, $know, $vulns, $vuln_know, $exp, $existsec, $secsolution, $interest, $reason, $p, $comment, $src, $sitetypes, $now, $happen, $statut);
		
		$this->load->model('market_model');
		$ret = $this->market_model->save_results($results);
		
		// send mail
		$mail_body = "New study filled !"; // check input + check it's not spam
		$to = "m.impini@gmail.com";
		$subject = "New study filled !";
		$body = $mail_body;
		mail($to, $subject, $body);
		
		// Load view
		$data['main_content'] = 'marketstudy_form_success';
		/*$opt_load = array(
		'<script type="text/javascript" src="http://deadislandcraft.com/jquery-1.4.2.min.js"></script>',
		'<script type="text/javascript" src="http://deadislandcraft.com/jquery.smartWizard-2.0.min.js"></script>',
		'<link rel="stylesheet" href="http://deadislandcraft.com/smart_wizard.css" type="text/css" />',
		);
		$title = "Market study";*/
		$opt_head = array(
			//"opt_load" => $opt_load,
			"title" => "Result",
		);
		$data['opt_head'] = $opt_head;
		$this->load->view('includes/templatemarket', $data);
	}
}