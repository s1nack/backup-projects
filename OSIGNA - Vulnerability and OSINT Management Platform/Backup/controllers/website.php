<?php

class site
{
	public $name = "MyName";
	public $status = "SECURE";
	public $lastscandate = "21-12-2012";
	public $lastscan = "INC-Full-OSINT";
	public $nbcrit = 17;
	public $nbvulns = 88;
	public $nbpages = 39;
	public $token = "f93u830dfj";
	public $id = 1;
}

class vuln
{
	public $type = "MyName";
	public $impact = "Critical";
	public $page = "/home/products";
	public $id = 1;
}

class domain
{
	public $nb = 0;
	public $group = "";
	public $rad = 0;
	public $host = "";
	
	public function setNb($n)
	{
		$this->nb = $n;
	}
	
	public function setGroup($g)
	{
		$this->group = $g;
	}
	
	public function setRad($r)
	{
		$this->rad = $r;
	}
	
	public function setHost($h)
	{
		$this->host = $h;
	}
}

class Website extends Auth_Controller {

	function index()
	{
		// do nothing
	}
	
	function add()
	{
		// load view : formulaire new site
		$data['main_content'] = 'new_website_form';

		$title = "Add a website";
		$opt_head = array(
			"title" => $title,
		);
		$data['opt_head'] = $opt_head;
		$this->load->view('includes/template-beta', $data);
	}
	
	function detail($siteID)
	{
		// get reports/getSiteReport($siteID)
		// load view : site_detail
		$report = null;
		$data['main_content'] = 'site_detail';
		$opt_load = array(
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/dashboardui.css" />',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/css3-buttons.css" />',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/test/force/force.css" />',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-1.6.4.min.js"></script>',
			'<script src="http://www.datalabsecurity.com/webscan/resources/js/jquery.easytabs.min.js" type="text/javascript"></script>',
			'<script type="text/javascript" src="https://www.google.com/jsapi"></script>',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/test/d3.v2.js"></script>',
			);
		$subitems = array('Summary' => 'website/summary', 'Vulnerabilities' => 'website/vulnerabilities', 'Sitemap' => 'website/sitemap', 'External content' => 'website/external', 'Search engines' => 'website/searchengine', 'Malware' => 'website/malware', 'Dns' => 'website/dns');
		$opt_head = array(
			"title" => "Targets",
			"opt_load" => $opt_load,
			"subitems" => $subitems,
			);
		
		// temp objects to replace with real sql request
		$vulns = array();
		for($i=0;$i<10;$i++)
		{
			$v = new vuln();
			$vulns[] = $v;
		}
		$opt = array($vulns);
		
		$data['opt'] = $opt;
		$data['opt_head'] = $opt_head;
		$this->load->view('includes/template-beta', $data);	
	}
	
	function summary()
	{
		$this->load_page('site_summary', 0);
	}
	
	function vulnerabilities()
	{
		$this->load_page('site_vuln', 1);
	}
	
	function sitemap()
	{
		$add = array(
			'<script type="text/javascript" src="http://www.datalabsecurity.com/test/d3.v2.js"></script>',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/d3.layout.js"></script>',
		);
		$this->load_page('site_sitemap', 2, $add);
	}
	
	function external()
	{
		$add = array(
			'<script type="text/javascript" src="http://www.datalabsecurity.com/test/d3.v2.js"></script>',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/test/force/force.css" />',
			'<script src="http://www.datalabsecurity.com/webscan/resources/js/jquery.easytabs.min.js" type="text/javascript"></script>',
		);
		$this->load_page('site_external', 3, $add);
	}
	
	function searchengine()
	{
		$report = simplexml_load_file("http://www.datalabsecurity.com/webscan/resources/data/2012-11-13.xml");
		$unique_domains = array();
		$i=0;
		$j=0;
		$ar = array();
		foreach ($report->sitemap->ext->external as $xmlextcontent)
		{
			if ($xmlextcontent['type'] == "link")
			{
				$exturl = $xmlextcontent['url'];
				$parse = parse_url($exturl);
				$extdomain = $parse['host'];
				$pieces = explode(".", $extdomain);
				$nbpieces = count($pieces);
				$exthost = $pieces[$nbpieces-2] . "." . $pieces[$nbpieces-1];
				if(!isset($ar[$exthost]))
				{
					$ar[$exthost] = 1;
				}
				
				if (!array_key_exists($extdomain, $unique_domains))	// test if abc.foo.com is already known
				{	// if it's not, create the object and add it in $unique_domains[abc.foo.com] 
					$newdomain = new domain;
					$newdomain->setNb(1);
					$newdomain->setRad(5);
					$newdomain->setGroup(1);
					$newdomain->setHost($exthost);
					$unique_domains[$extdomain] = $newdomain;
				}
				else // if it is..
				{
					$curNb = $unique_domains[$extdomain]->nb;
					$unique_domains[$extdomain]->setNb($curNb+1);
					$curRad = $unique_domains[$extdomain]->rad; // get current rad
					if ($curRad < 7) { $unique_domains[$extdomain]->setRad($curRad+1); } // must be smaller than root node
				}
			}
		}
		
		$selected_domains = array();
		$i=0;
		foreach($unique_domains as $k=>$v)
		{
			if ($v->nb > 1)
			{
				$selected_domains[$k] = $v;
				$i++;
			}
			else
			{
				if ($i < 20)
				{
					$selected_domains[$k] = $v;
					$i++;
				}
			}
		}

		$jsondata = '';
		$jsondata .= '{"nodes":[';
		$jsondata .= '{"ind":10,"name":"www.olfeo.com","host":"www.olfeo.com","stroke":"#e62626","group":1,"ip":"10.10.10.10","url":"test.com", "radius":8},';
		$j=0;
		$i=1;
		foreach($selected_domains as $k=>$v)
		{
			$j += 0.5;
			$jsondata .= '{"ind":'.$i.',"name":"' . $k . '","host":"'.$v->host.'","stroke":"white","group":'.$j.',"ip":"10.10.10.10","url":"test.com","radius":'.$v->rad.'},';
			$i++;
		}
		$jsondata = rtrim($jsondata, ',');
		$jsondata .= '],"links":[';
		$i=0;
		foreach($selected_domains as $k=>$v)
		{
			$i++;
			$jsondata .= '{"ind":'.$i.',"source":0,"target":' . $i . ',"value":1},';
		}
		$jsondata = rtrim($jsondata, ',');
		$jsondata .= ']}';
	
		$myfile = "resources/data/externalcontent.json";
		$fh = fopen($myfile, 'w');
		fwrite($fh, $jsondata);
		fclose($fh);
	
		$this->load_page('site_se', 4);
	}
	
	function malware()
	{
		$this->load_page('site_malware', 5);
	}
	
	function dns()
	{
		$this->load_page('site_dns', 6);
	}
	
	function load_page($f, $p, $s=NULL)
	{
		//$opt = array($this->fullsites, $s);
		$data['opt'] = null;
		$data['main_content'] = $f;
		$opt_load = array(
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/jquery-ui-1.8.2.custom.css" />',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/css3-buttons.css" />',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-1.6.4.min.js"></script>',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-ui-1.8.16.custom.min.js"></script>',
			'<script src="http://www.datalabsecurity.com/webscan/resources/js/jquery.easytabs.min.js" type="text/javascript"></script>',
			'<script src="http://www.datalabsecurity.com/webscan/resources/js/mytables.js" type="text/javascript"></script>',
			'<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>',
		);
		if($s != NULL) { $opt_load = array_merge($opt_load, $s); }
		$subitems = array('Summary' => 'website/detail/1', 'Vulnerabilities' => 'website/vulnerabilities', 'Sitemap' => 'website/sitemap', 'External content' => 'website/external', 'Search engines' => 'website/searchengine', 'Malware' => 'website/malware', 'Dns' => 'website/dns');
		$title = "Website";
		$opt_head = array(
			"opt_load" => $opt_load,
			"title" => $title,
			"subitems" => $subitems,
			"defaultTab" => $p,
		);
		$data['opt_head'] = $opt_head;
		$this->load->view('includes/template-beta', $data);
	}

// limit v1
/*
	public $fullsites = array();
	
	public function __construct()
	{
		parent::__construct();
		$this->load->library('api');
		$sitesIds = $this->api->getWebsiteIdsByUseridA($this->session->userdata('id'));
		foreach ($sitesIds as $siteId)
		{
			$this->fullsites[$siteId['id']] = trim($this->api->getUrlById($siteId['id']));
		}
	}
	
	function index()
	{
	//echo "FOO";
	}
	
	function add() 
	{
		$data['main_content'] = 'new_website_form';

		$title = "Add a website";
		$opt_head = array(
			"title" => $title,
		);
		$data['opt_head'] = $opt_head;
		$this->load->view('includes/template-beta', $data);
	}
	
	function manage($selected = NULL)
	{		
		// Get the selected tab ID from URL
		$selectedtab = $this->uri->segment(4, 0);
		
		// Load vulns
		$this->load->model('vuln_model');
		$s = $this->vuln_model->getVulnsSummary(1);
		$v = $this->vuln_model->getVulns(1);
		
		// Load view
		$data['main_content'] = 'manage_website_form';
		$opt = array($this->fullsites, $s, $selected);
		$data['opt'] = $opt;
		$opt_load = array(
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/dashboardui.css" />',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/jquery-ui-1.8.2.custom.css" />',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/css3-buttons.css" />',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-1.6.4.min.js"></script>',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-ui-1.8.16.custom.min.js"></script>',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery.dashboard.min.js"></script>',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/themeroller.js"></script>',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/tabber.js"></script>',
			'<script type="text/javascript" src="https://www.google.com/jsapi"></script>',
			'<script src="http://www.datalabsecurity.com/webscan/resources/js/jquery.easytabs.min.js" type="text/javascript"></script>',
			);
		$subitems = array('Summary', 'Vulnerabilities', 'Site map', 'External content');		
		$opt_head = array(
			"title" => "Websites",
			"opt_load" => $opt_load,
			"subitems" => $subitems,
			"defaultTab" => $selectedtab,
			);
		$data['opt_head'] = $opt_head;		
		$this->load->view('includes/template-beta', $data);
	}
	
	function add_website()
	{	
		$userid = $this->session->userdata('id');

		$this->load->model('users_model');
		$new_website = $this->input->post('newsite'); // TODO : Validate INPUT
		
		$ret = $this->verify_website_ownership($new_website);
		if ($ret == 1)
		{
			echo "Failed to verify website ownership.\r\n Please contact Support. ";
			return 1;
		}
		
		// $userid = $this->session->userdata('id');
		// $url = "test.com";
		// $ipv4 = "123.456.789.101";
		
		// //include APPPATH.'application/views/include/xmlrpc.inc';
		// include APPPATH.'includes/xmlrpc.inc';
		// // Make an object to represent our server.
		// $server = new xmlrpc_client('/api/sample.php','xmlrpc-c.sourceforge.net', 80);
		// // Send a message to the server.
		// $message = new xmlrpcmsg('sample.sumAndDifference',
			// array(new xmlrpcval(5, 'int'),
			// new xmlrpcval(3, 'int'))
		// );
		// $result = $server->send($message);
		// // Process the response.
		// if (!$result) {
			// print "<p>Could not connect to HTTP server.</p>";
		// } elseif ($result->faultCode()) {
			// print "<p>XML-RPC Fault #" . $result->faultCode() . ": " .
			// $result->faultString();
		// } else {
			// $struct = $result->value();
			// $sumval = $struct->structmem('sum');
			// $sum = $sumval->scalarval();
			// $differenceval = $struct->structmem('difference');
			// $difference = $differenceval->scalarval();
			// print "<p>Sum: " . htmlentities($sum) .
			// ", Difference: " . htmlentities($difference) . "</p>";
		// }
		
		// Check if more than 1 ip is associated with the host
		$this->website_lookup($new_website);

		return 0;
		
		$q = $this->users_model->create_site($userid, $new_website, $ipv4);
		if ($q)
		{
			redirect('website/manage');
		}
		else
		{
			redirect('website/add');
		}	
	}
	
	function verify_website_ownership($site) // TODO : check url format prior usage. Currently : abc.com
	{	
	return 0;
		$url = "http://" . $site;
		$str = file_get_contents($url);
		$regex = '<!--sectoken(.*?)-->';
		if(preg_match($regex,$str,$match)!=1)
		{
			echo "TOKEN NOT FOUND !";
			return 1;
		}
		// TODO : check match[1] content to prevent sql injection ..
		$this->load->model('website_model');
		$dbToken = $this->website_model->get_secureToken($this->session->userdata('id'));
		if ($match[1] == $dbToken)
		{
			echo "WEBSITE SUCCESSFULLY CHECKED !";
			return 0;
		}
		else
		{
			echo "WRONG TOKEN !";
			return 1;
		}
	}
	
	function website_lookup($host = NULL)
	{
		if ($this->input->post('newsite') != NULL)
		{
			$host = $this->input->post('newsite');
		}
		if ($host)
		{
			$ips = gethostbynamel($host);
		}
		else 
		{
			echo "Error : no url supplied\r\n";
			return -1;
		}
		
		if (count($ips) > 1)
		{
			$str = "Several IP addresses were found for this host (".$host.") :</br></br>";
			foreach ($ips as $i)
			{
				$str = $str . $i . "</br>";
			}
			echo $str;
		}
		else
		{
			echo "One IP Address found : " . $ips[0];
		}
		
		return 0;
	}
*/
}