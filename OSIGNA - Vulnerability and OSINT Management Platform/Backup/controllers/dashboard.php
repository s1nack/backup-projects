<?php

class Dashboard extends Auth_Controller {

	function index()
	{
		//echo base_url();
		$this->load->library('api');
		$this->load->model('website_model');
		$this->load->model('scan_model');
	
		$data['main_content'] = 'dashboard_view';
		$opt_load = array(
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/dashboardui.css" />',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/css3-buttons.css" />',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/jquery-ui-1.8.2.custom.css" />',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-1.6.4.min.js"></script>',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-ui-1.8.16.custom.min.js"></script>',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery.dashboard.min.js"></script>',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/themeroller.js"></script>',
			);

		$subitems = array('Start new scan' => 'scan', 'Add new website' => 'website/add', 'Manage account' => 'settings/account');
		
		$opt_head = array(
			"title" => "Dashboard",
			"opt_load" => $opt_load,
			"subitems" => $subitems,
			);

		// Get websites info
		$sitesIds = $this->api->getWebsiteIdsByUseridA($this->session->userdata('id'));
		foreach ($sitesIds as $sid) 
		{
			$a[] = $sid['id']; 
		}
		$sitesInfos = $this->website_model->get_all($a);
		$opt = array($sitesInfos);
		
		// Get last scans info for each website
		$lastScansIds = array();
		foreach ($a as $siteid)
		{
			$lastScansInfos[$siteid] = $this->scan_model->getLastScanInfos($siteid);
			//print_r($lastScansInfos[$siteid]);
		}
		$opt[] = $lastScansInfos;
		
		// Load the view
		$data['opt'] = $opt;
		$data['opt_head'] = $opt_head;
		$this->load->view('includes/template-beta', $data);
	}
	
}