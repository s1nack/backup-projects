var width = 600,
    height = 400;

var color = d3.scale.category20();

var force = d3.layout.force()
    .charge(-120)
    .linkDistance(30)
    .size([width, height]);
	
var synchronizedMouseOver = function() {
	var circle = d3.select(this);
    //circle.style('fill', '#000');
	circle.style('stroke', '#bbb');
	//var legend = document.getElementById('legend');
	//var header = circle.
	//legend.innerHTML = 'Site detail (click on it to view more..)';
};

var synchronizedMouseOut = function() {
	//var foo = resetBorders();
	//var circle = d3.select(this);
	//var colorValue = circle.attr("color_value");
    //circle.style('fill', colorValue);
	//var legend = document.getElementById('legend');
	//legend.innerHTML = '';
};

var synchronizedMouseDown = function() {
	var foo = resetBorders();
	var circle = d3.select(this);
    //circle.style('fill', '#000');
	circle.style('stroke', 'red');
	var legend = document.getElementById('legend');
	legend.style.border = 'border:1px solid #aaa;';
	var ip = circle.attr("detail");
	var url = circle.attr("url");
	var name = circle.attr("name");
	legend.innerHTML = "<div style='border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#ddd;'><p style='height:10px;color:maroon;margin-left:10px;font-size:120%;font-weight:bold;'>" + name 
	+ "<span style='color:#777;font-size:90%;font-weight:normal;margin-left:15px;'>Internal network</span>"
	+ "<div style='position:absolute;margin-left:500px;margin-top:-15px;width:150px;'><span><img width='12' height='12' src='http://www.datalabsecurity.com/webscan/resources/img/Button_Next.png' /></span><span style='margin-left:5px;text-decoration:underline;'>Scan now</span></div>"
	+ "</p></div>"

	+ "<p style='color:#black;margin-left:10px;margin-top:10px;'>"
	+ "IP : <span style='color:maroon;font-size:115%;'>" + ip + "</span></br>" 
	+ "Domain : <span style='color:maroon;font-size:115%;'>" + url + "</span></br>"
	+ "</br><span style='font-size:120%;'>Malware status : </span>"
	+ "<div style='position:absolute;margin-left:115px;margin-top:-35px;'>"
	+ "<button style='width:60px;height:20px !important;' class='action green'><span style='margin-left:-10px;margin-top:-3px;' class='label'>CLEAN</span></button></div>"
	+ "<div style='position:absolute;margin-left:10px;'>"
	+ "</br><span style='font-size:120%;'>Imported files : </span></br>"
	+ "<span style='color:#777;'>foo.olfeo.com/data2/</span><span style='color:black;'>provide2.js</span></br>"
	+ "<span style='color:#777;'>foo.olfeo.com/api/jsapi/</span><span style='color:black;'>provide.js</span></br>"
	+ "<span style='color:#777;'>foo.olfeo.com/api/jsapi/</span><span style='color:black;'>provide3.js</span></br>"
	+ "<span style='color:#777;'>foo.olfeo.com/api/jsapi/</span><span style='color:black;'>set.js</span></br>"
	+ "<span style='color:#777;'>foo.olfeo.com/api/jsapi/</span><span style='color:black;'>get.js</span></br>"
	+ "</div>"
	+ "</p>";
};

var resetBorders = function() {
	var circles = svg.selectAll("circle.node")
	.style("stroke", "white");
}

// Color Scale Handling...
var colorScale = d3.scale.category20c();

var svg = d3.select("#chart").append("svg")
    .attr("width", width)
    .attr("height", height);

d3.json("http://www.datalabsecurity.com/test/force/olfeo.json", function(json) {
  force
      .nodes(json.nodes)
      .links(json.links)
      .start();

  var link = svg.selectAll("line.link")
      .data(json.links)
    .enter().append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return Math.sqrt(d.value); });

  var node = svg.selectAll("circle.node")
      .data(json.nodes)
    .enter().append("circle")
		.on('mouseover', synchronizedMouseOver)
		.on('mouseout', synchronizedMouseOut)
		.on('mousedown', synchronizedMouseDown)
		.attr("color_value", function(d, i) { return colorScale(i); }) // Bar fill color...
      .attr("class", "node")
      .attr("r", 5)
	  .attr("detail", function(d) { return d.ip; })
	  .attr("url", function(d) { return d.url; })
	  .attr("name", function(d) { return d.name; })
      .style("fill", function(d) { return color(d.group); })
	  .style("stroke", "white");

  node.append("title")
      .text(function(d) { return d.name; });
	  
  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node.attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  });
});
