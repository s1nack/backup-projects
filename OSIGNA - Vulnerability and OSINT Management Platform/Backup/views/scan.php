<?php

class Scan extends Auth_Controller {

	public $fullsites = array();
	
	// array 1=OWASP-TOP-10 2=XSS-SQLI 3=FULL ( scantype in db )
	
	public function __construct()
	{
		parent::__construct();
		$this->load->library('api');
		$sitesIds = $this->api->getWebsiteIdsByUseridA($this->session->userdata('id'));
		foreach ($sitesIds as $siteId)
		{
			$this->fullsites[$siteId['id']] = trim($this->api->getUrlById($siteId['id']));
		}
	}
	
	function index($foo = NULL)
	{	
		// Load view
		
		// Load sites
		$opt = array($this->fullsites, $foo);
		$data['opt'] = $opt;
		//print_r($this->fullsites);
		$data['main_content'] = 'scan_form';
		
		$opt_load = array(
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/css3-buttons.css" />',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/jquery-ui-1.8.2.custom.css" />',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-1.6.4.min.js"></script>', // required for tabs
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-ui-1.8.16.custom.min.js"></script>',
			'<script src="http://www.datalabsecurity.com/webscan/resources/js/jquery.easytabs.min.js" type="text/javascript"></script>',
		);
		$title = "Scanning";
		$subitems = array('New scan', 'Scan list', 'Running scans', 'Schedule scan', 'Options');
		$opt_head = array(
			"opt_load" => $opt_load,
			"title" => $title,
			"subitems" => $subitems,
		);
		$data['opt_head'] = $opt_head;
		$this->load->view('includes/template-beta', $data);
	}
	
	function validate_scan()
	{
		//$scan_name = $this->input->post('scanname');
		//$scan_type = $this->input->post('scantype');
		$siteid = trim($this->input->post('scansite'));
		$url = $this->fullsites[$siteid];
		$scanid = $this->newscan();
		
		//echo "You chose : ", $scan_type, " option.<br><br>";
		//echo "Scan name : ", $scan_name;
		//echo "<br><br> I should generate an xml-rpc request now...</br>";
		/*echo "GET url?userid=".$this->session->userdata('id')."&siteid=".$siteid."&url=".$url."&scanid=".$scanid."</br>";
		echo "</br></br>";
		echo "File should be : /var/www/webscan/data/".$this->session->userdata('id')."/".$siteid."/".$scanid."-01-31-2012.xml</br></br></br>"; 
		echo "il faudrait prevoir la date de lancement dans l'url aussi pour les schedules en crontab</br>";
		echo "genre GET url?userid=".$this->session->userdata('id')."&siteid=".$siteid."&url=".$url."&scanid=".$scanid."&scandate=MMDDYY</br>";
		*/
		$url = @file_get_contents('http://localhost:8765/fullscan?userid=1&siteid=2&scanid=4&url=www.google.com');
		if ($url) {
			redirect('scan/scandetail');
		} else {
			echo "Connection error : can not connect to scan server !";
			redirect('scan/scandetail');
		}
		
	}

	function templates()
	{
		// Load view
		$data['main_content'] = 'scan_templates_form';
		$this->load->view('includes/template2', $data);
	}
	
	function running()
	{
		// Load view
		$data['main_content'] = 'scan_running_form';
		$this->load->view('includes/template2', $data);
	}
	
	function newscan()
	{
		$this->load->model('scan_model');
		$scanid = $this->scan_model->create_scan();
		return $scanid;
	}
	
	function scandetail()
	{
		$data['main_content'] = 'scan_detail_form';
		$opt_load = array(
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/progress.js"></script>',
			'<script src="http://www.datalabsecurity.com/webscan/resources/js/jquery.easytabs.min.js" type="text/javascript"></script>',
			);
		$subitems = array('New scan', 'Scan list', 'Running scans', 'Schedule scan', 'Options');
		$opt_head = array(
			"title" => "Scan in progress",
			"opt_load" => $opt_load,
			"subitems" => $subitems,
			);
		$data['opt_head'] = $opt_head;
		$this->load->view('includes/template-beta', $data);
	}
}