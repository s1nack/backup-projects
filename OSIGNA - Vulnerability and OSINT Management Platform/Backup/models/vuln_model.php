<?php

class Vuln_model extends CI_Model {

	public function __construct()
	{
		$params = array('type' => "a", 'loc' => "b", 'payload' => "c");
		$CI =& get_instance();
		$CI->load->library('vuln', $params);
	}
	
	function getVulns($scanId)
	{
		// CODE TO PARSE XML
		// LOAD VULN LIBRARY AND CREATE VULN OBJECTS
		// RETURN VULN OBJECTS ARRAY
		
		$vulnArray = array();
		$xmlfile = base_url() . "resources/data/sample-report.xml";
		$report = simplexml_load_file($xmlfile); // change $xmlfile to the report associated with the $scanId
		
		foreach ($report->Scan as $scan)
		{
			if ($scan['method'] == "web")
			{
/* 				echo "Target : " . $scan->Site['name'] . " (" . $scan->Site->SiteIp . ")" . " <br />";
				echo "Scan level : " . $scan['level'] . "<br />";
				echo "<br />";
				echo $scan->Site->Vulns->Crit->Vuln->count() . " Critical | " . +
					$scan->Site->Vulns->Medium->Vuln->count() . " Medium | " . +
					$scan->Site->Vulns->Low->Vuln->count() . " Low | " . +
					$scan->Site->Vulns->Info->Vuln->count() . " Infos <br />";
				foreach ($scan->Site->Vulns->Crit->Vuln as $crit_vuln)
				{
/* 					echo "Type : " . $crit_vuln->Type . "<br/>";
					echo "Location : " . $crit_vuln->Location . "<br/>";
					echo "Payload : " . $crit_vuln->Payload . "<br/><br/>"; 
				}*/
			}
		}
		
/* 		$b = "sqli";
		$v = array('type' => "sqli", 'loc' => "http://www.olfeo.com/login", 'payload' => "?user=admin");
		$test = new vuln($v);
		$vulnArray[] = $test;
		$test2 = new vuln($v);
		$vulnArray[] = $test2; */
		return $vulnArray;
	}
	
	function getVulnsSummary($scanId)
	{
		$sum = array();
		$xmlfile = base_url() . "resources/data/sample-report.xml";
		$report = simplexml_load_file($xmlfile);
		
		foreach ($report->Scan as $scan)
		{
			if ($scan['method'] == "web")
			{
				$sum['crit'] = $scan->Site->Vulns->Crit->Vuln->count();
				$sum['med'] = $scan->Site->Vulns->Medium->Vuln->count();
				$sum['low'] = $scan->Site->Vulns->Low->Vuln->count();
				$sum['info'] = $scan->Site->Vulns->Info->Vuln->count();
				$sum['all'] = array_sum($sum);
			}
		}
		
		return $sum;
	}

}