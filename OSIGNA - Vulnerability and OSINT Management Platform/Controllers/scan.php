<?php

class scantemplate
{
	public $name = "INC-Full-OSINT";
	public $startdate = "21-12-2012";
	public $progress = "50%";
	public $nbcrit = 6;
	public $nbvulns = 17;
	public $id = 1;
}

class scan_running extends scantemplate
{
	public $status = "RUNNING";
}

class scan_finished extends scantemplate
{
	public $status = "FINISHED";
}

class scan_pending extends scantemplate
{
	public $status = "PENDING";
}

class Scan extends Auth_Controller {

	function index()
	{
		// load view : liste des scans
		$data['main_content'] = 'scan_index';
		$opt_load = array(
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/dashboardui.css" />',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/css3-buttons.css" />',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-1.6.4.min.js"></script>',
			'<script src="http://www.datalabsecurity.com/webscan/resources/js/jquery.easytabs.min.js" type="text/javascript"></script>',
			);
		$subitems = array('Summary', 'Scheduling');
		$opt_head = array(
			"title" => "Scans",
			"opt_load" => $opt_load,
			"subitems" => $subitems,
			);
			
		// temp objects to replace with real sql request
		$scansr = array();
		for ($i=0;$i<3;$i++)
		{
			$s = new scan_running();
			$scansr[] = $s;
		}
		$scansf = array();
		for ($i=0;$i<3;$i++)
		{
			$s = new scan_finished();
			$scansf[] = $s;
		}
		$scansp = array();
		for ($i=0;$i<3;$i++)
		{
			$s = new scan_pending();
			$scansp[] = $s;
		}
		
		$opt = array($scansr, $scansf, $scansp);
		$data['opt'] = $opt;
		$data['opt_head'] = $opt_head;
		$this->load->view('includes/template-beta', $data);	
	}
	
	function add()
	{
		// load view : formulaire new scan
		$data['main_content'] = 'scan_add';
		$opt_load = array(
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/dashboardui.css" />',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/css3-buttons.css" />',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/progress.css" />',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-1.6.4.min.js"></script>',
			'<script src="http://www.datalabsecurity.com/webscan/resources/js/jquery.easytabs.min.js" type="text/javascript"></script>',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/progress.js"></script>',
			);
		$opt_head = array(
			"title" => "Scans",
			"opt_load" => $opt_load,
			);
		$data['opt_head'] = $opt_head;
		$this->load->view('includes/template-beta', $data);	
	}
	
	function detail($scanID)
	{
		// load view : scan_detail
		$data['main_content'] = 'scan_detail';
		$opt_load = array(
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/dashboardui.css" />',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/css3-buttons.css" />',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/progress.css" />',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-1.6.4.min.js"></script>',
			'<script src="http://www.datalabsecurity.com/webscan/resources/js/jquery.easytabs.min.js" type="text/javascript"></script>',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/progress.js"></script>',
			);
		$opt_head = array(
			"title" => "Scans",
			"opt_load" => $opt_load,
			);
		$data['opt_head'] = $opt_head;
		$this->load->view('includes/template-beta', $data);	
	}
	
// limit v1
/*
	public $fullsites = array();
	
	public function __construct()
	{
		parent::__construct();
		$this->load->library('api');
		$sitesIds = $this->api->getWebsiteIdsByUseridA($this->session->userdata('id'));
		foreach ($sitesIds as $siteId)
		{
			$this->fullsites[$siteId['id']] = trim($this->api->getUrlById($siteId['id']));
		}
	}
	
	function index2()
	{
	//foo
	}
	
	function index()
	{	
		$foo = $this->uri->segment(3, 0);
		$selectedtab = $this->uri->segment(4, 0);
		
		$this->load->library('api');
		$this->load->model('scan_model');
		
		// Load sites
		$opt = array($this->fullsites, $foo);
		//$data['opt'] = $opt;
		//print_r($this->fullsites);
		$data['main_content'] = 'scan_form';
		
		$opt_load = array(
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/css3-buttons.css" />',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/jquery-ui-1.8.2.custom.css" />',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-1.6.4.min.js"></script>', // required for tabs
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/jquery-ui-1.8.16.custom.min.js"></script>',
			'<script src="http://www.datalabsecurity.com/webscan/resources/js/jquery.easytabs.min.js" type="text/javascript"></script>',
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/progress.js"></script>',
		);
		$title = "Scanning";
		$subitems = array('New scan', 'Scan list', 'Running scans');
		$opt_head = array(
			"opt_load" => $opt_load,
			"title" => $title,
			"subitems" => $subitems,
			"selectedtab" => $selectedtab,
		);
		$data['opt_head'] = $opt_head;
		
		$scanIds = $this->api->getScanIdsByUseridA($this->session->userdata('id'));
		if($scanIds)
		{
			//print_r($scanIds);
			foreach ($scanIds as $scanid) 
			{
				//print_r($sid);
				$b[] = $scanid['id']; 
			}
			$ret = $this->scan_model->get_all($b);
			$opt[] = $ret;
			//print_r($opt);
			//$data['opt'] = $opt;
		}	
		
		$data['opt'] = $opt;
		
		$this->load->view('includes/template-beta', $data);
	}
	
	function validate_scan()
	{
		//$scan_name = $this->input->post('scanname');
		//$scan_type = $this->input->post('scantype');
		$siteid = trim($this->input->post('scansite'));
		//$scantype = trim($this->input->post('scantype'));
		$url = $this->fullsites[$siteid];
		$scanname = "My first scan";
		$scanid = $this->createscan($siteid, $scanname);
		
		//echo "You chose : ", $scan_type, " option.<br><br>";
		//echo "Scan name : ", $scan_name;
		//echo "<br><br> I should generate an xml-rpc request now...</br>";
		//echo "GET url?userid=".$this->session->userdata('id')."&siteid=".$siteid."&url=".$url."&scanid=".$scanid."</br>";
		//echo "</br></br>";
		//echo "File should be : /var/www/webscan/data/".$this->session->userdata('id')."/".$siteid."/".$scanid."-01-31-2012.xml</br></br></br>"; 
		//echo "il faudrait prevoir la date de lancement dans l'url aussi pour les schedules en crontab</br>";
		//echo "genre GET url?userid=".$this->session->userdata('id')."&siteid=".$siteid."&url=".$url."&scanid=".$scanid."&scandate=MMDDYY</br>";
		
		$url = @file_get_contents('http://localhost:8765/fullscan?userid='.$this->session->userdata('id').'&siteid='.$siteid.'&scanid='.$scanid.'&url='.$url);
		if ($url) {
			redirect('scan/scandetail/'.$scanid);
		} else {
			echo "Connection error : can not connect to scan server !";
			redirect('scan/scandetail/'.$scanid);
		}
	}
	
	function ajax_validateScan()
	{
		$siteid = trim($this->input->post('siteid'));
		$scantype = trim($this->input->post('scantype'));
		//echo "SITEID = ".$siteid;
		//echo $scantype;
		$url = @file_get_contents('http://localhost:8765/fullscan?userid=3&siteid=2&scanid=6&url=www.google.com');
		if ($url) {
			echo $url;
		} else {
			echo -1;
		}
	}

	function templates()
	{
		// Load view
		$data['main_content'] = 'scan_templates_form';
		$this->load->view('includes/template2', $data);
	}
	
	function running()
	{
		// Load view
		$data['main_content'] = 'scan_running_form';
		$this->load->view('includes/template2', $data);
	}
	
	function createscan($sid, $name)
	{
		$this->load->model('scan_model');
		$scanid = $this->scan_model->create_scan($sid,$name);
		return $scanid;
	}
	
	function scandetail($sid = NULL)
	{
		$this->load->model('scan_model');
		
		$data['main_content'] = 'scan_detail_form';
		$opt_load = array(
			'<script type="text/javascript" src="http://www.datalabsecurity.com/webscan/resources/js/progress.js"></script>',
			'<link rel="stylesheet" type="text/css" href="http://www.datalabsecurity.com/webscan/resources/css/css3-buttons.css" />',
			);
		$opt_head = array(
			"title" => "Scan in progress",
			"opt_load" => $opt_load,
			);
		$data['opt_head'] = $opt_head;
		
		$ar = array($sid);
		$ret = $this->scan_model->get_all($ar);
		$opt = array($ret);
		$data['opt'] = $opt;
		
		$this->load->view('includes/template-beta', $data);
	}
*/
}